# Mac ‚Äî History

## Learnings
- Project started 2026-02-22. Backend for AI Office Squad.
- AIOffice server at apps/server/ ‚Äî Express + PTY + WebSocket.
- Server spawns CLI processes (Claude Code / Copilot CLI) in PTYs, bridges JSONL output over WebSocket.
- Need to integrate @bradygaster/squad-cli v0.7.0 for squad-aware agent management.
- Phase 0+1 done: multi-squad building model, team.md parser, squad-scoped endpoints.
- New modules: squad-reader.ts (parses team.md), building-routes.ts (REST API + squad state).
- squad-types.ts added to shared/src/ for cross-package types.
- squadoffice.config.json at project root defines squad directories; auto-detects if missing.
- Agents auto-seeded from .squad/team.md on server startup ‚Äî no manual spawn needed.
- Scribe and Ralph are hidden (system agents, not NPCs).
- Charter + history files injected as personality context when spawning squad agent PTYs.
- bridgeChatToPty() now loads charter + history from agent's squad member record on first message (Issue #2).
- Squad agents get a tailored prompt with their charter/role context; non-squad agents keep generic office personality.
- Ceremony API added: POST /api/squads/:squadId/ceremonies/:type (start) and POST .../ceremonies/:ceremonyId/end (end).
- parseCeremoniesMd() parses .squad/ceremonies.md into structured CeremonyConfig objects.
- CeremonyType, CeremonyState, CeremonyConfig types added to shared/src/squad-types.ts.
- EventTypeSchema extended with "ceremony.start", "ceremony.end", "decisions.update" in shared/src/schema.ts.
- Enhanced squad status endpoint: GET /api/squads/:squadId/status returns members with live agent cross-reference, blockers, active ceremony, decision count.
- createBuildingRouter now accepts opts param for getAgents() and broadcast() wiring from index.ts.
- In-memory activeCeremonies map tracks running ceremonies; ceremony.start/end broadcast over WebSocket.
- Electron desktop app scaffold created at apps/desktop/ using electron-vite + React.
- Main process (src/main/) owns all Squad SDK state; renderer communicates via typed IPC.
- SquadRuntime class wraps SquadClientWithPool, EventBus, StreamingPipeline, RalphMonitor lifecycle.
- IPC channels: 12 invoke (renderer‚Üímain) + 4 push (main‚Üírenderer) with IpcResult<T> error wrapping.
- squad-sdk is ESM-only; main process uses dynamic import() for subpath exports.
- types.ts defines shared IpcInvokeChannels/IpcPushChannels maps ‚Äî single source of truth for channel contracts.
- @electron-toolkit/utils used for `is.dev` check and ELECTRON_RENDERER_URL loading.
- Preload exposes `window.squadAPI` via contextBridge with unsubscribe-returning event listeners.
- Poncho's pre-existing tailwind.config.ts and postcss.config.js in apps/desktop/ ‚Äî no conflicts with backend scaffold.
- Phase 1a types added: HubStats, SquadInfo, SquadStatus, SessionMetadata, SessionDetail, AgentInSession ‚Äî all in main/types.ts and mirrored in renderer/types.ts.
- IPC channel `squad:get-session-detail` added: fetches session via listSessions(), cross-references roster + agent statuses, returns SessionDetail.
- IpcInvokeChannels and IpcPushChannels maps updated with new channels (squad:get-session-detail, hub:stats-updated, hub:squad-status).
- Preload exposes `getSessionDetail(sessionId)` method on the squadAPI bridge.
- Vitest added as devDependency, vitest.config.ts created at apps/desktop/ root, test/test:watch scripts in package.json.
- Test directory structure: apps/desktop/src/__tests__/{main,renderer/{hooks,components}}.
- AgentStatus 'busy' maps to AgentInSession 'active' in the session-detail handler (SDK uses busy/idle, UI uses active/idle).
- Phase 1d: Refactored App.tsx to use useNavigation() and useChat() hooks ‚Äî replaced ~200 lines of inline state with hook calls.
- App.tsx now renders 3-level conditional: BuildingView (building) | FloorView (floor) | OfficeView (office) based on navigation.state.level.
- Header.tsx wired with Breadcrumb component from shared/ ‚Äî shows clickable Hub ‚Ä∫ Squad ‚Ä∫ Session trail.
- Sidebar.tsx updated to accept SquadSummary[] (with id, floor, memberCount) instead of string[]; shows hub name header and floor numbers.
- StatusBar.tsx extended with totalMembers and connected props ‚Äî shows connection dot and member count.
- Agent selection uses dual-state: local state for floor-level sidebar clicks, navigation hook's selectAgent for office-level.
- effectiveAgent pattern: nav hook's selectedAgentName at office level, local selectedAgent otherwise ‚Äî feeds into useChat().
- ChatPanel renders at any level when an agent is selected; OfficeView (per Poncho's comment) delegates chat integration to App.tsx.
- Keyboard: Escape clears agent selection first, then calls navigation.back(). Number keys 1-9 select agents at floor level.
- Breadcrumb navigate to Hub from office level calls navigation.back() twice ‚Äî functional state updates chain correctly in React.
- Poncho built all floor/ and office/ components (FloorView, SessionCard, FloorHeader, OfficeView, DeskWorkstation, WaterCooler, TerminalPanel) before Phase 1d.
- electron-vite build passes with all Phase 1d changes (54 modules, no errors).
- **SDK API fixes (2026-02-22):** SquadClientWithPool requires `connect()` call after instantiation; sessions are objects with `send`/`sendAndWait` methods (not `client.sendMessage`); shutdown via `client.shutdown()` not `close()`. Session objects stored in Map<string, session> for message routing. ErrorBoundary added to renderer to prevent white-screen crashes.
- **Session object patterns learned:** Squad SDK session objects are the primary messaging interface; they have `send`, `sendAndWait`, `on`, `getMessages`, `destroy`, and `abort` methods. The SquadClientWithPool doesn't have direct message methods ‚Äî all I/O is session-mediated. Lifecycle: instantiate ‚Üí connect ‚Üí createSession ‚Üí operations via session ‚Üí session.destroy ‚Üí shutdown on cleanup.
- **Init guard pattern:** `_initAttempted` + `_initPromise` prevents concurrent init calls and stops createSession() from re-spawning CLI subprocesses on every call. Once init is attempted (success or fail), subsequent calls return immediately.
- **SDK readiness checks:** All SDK-dependent methods (listSessions, getStatus, getAuthStatus, listModels) now check `_isReady` before touching `this.client` ‚Äî prevents cryptic null-ref errors when SDK isn't connected.
- **File-based IPC for non-SDK data:** `squad:get-decisions` reads `.squad/decisions.md` directly from disk, no SDK needed. Good pattern for any `.squad/` file the renderer needs.
- **ConnectionInfo IPC:** `squad:get-connection-info` returns `{ connected, error?, squadRoot }` so renderer can display SDK state without guessing.
- **Session crash fix (2026-02-22):** Root cause was SquadClientWithPool not cleaned up after failed `connect()` ‚Äî the partially-initialized SDK client had internal async handlers (sockets, child processes, reconnect timers) that could fire and crash the Electron main process. Fix: nullify `this.client` (with best-effort `shutdown()`) in the init catch block. Also: `createSession()` now awaits `_initPromise` to avoid racing, wraps `client.createSession()` in its own try/catch, and validates `agentName`. Preload bridge wraps all `ipcRenderer.invoke` calls with `.catch()` so IPC-level failures return `{ok:false}` instead of becoming unhandled rejections. `useChat.ts` validates agentName before calling IPC. `App.tsx` always calls `chat.createSession()` on "New Session" click (even without agent selected) so the error surfaces in the banner.
- **HookPipeline Governance Panel:** Added `HookEvent` type to main/types.ts and renderer/types.ts. SquadRuntime stores hook events in a circular buffer (max 50) and subscribes to `pipeline.onHook()` if available during init. `getHookActivity()` returns a safe copy of events (empty array if SDK unavailable ‚Äî never throws). IPC channel `squad:get-hook-activity` added with `handle()` wrapper. Preload exposes `getHookActivity()` with `.catch()` guard. HooksPanel.tsx component follows DecisionsTimeline pattern: fetch-on-mount, refresh button, error/empty/timeline states. App.tsx gets a third toggleable panel option (`'hooks'`) with üõ°Ô∏è icon. Color-coded badges: blocked=red, scrubbed=yellow, permitted=green, info=blue.
- **onConnectionState push channel:** Added `onConnectionState` to SquadAPI interface and implementation in preload/index.ts. Listens on `squad:connection-state` IPC channel (pushed by ipc-handlers.ts on runtime.onReady). Follows same pattern as onEvent/onStreamDelta/onStreamUsage ‚Äî typed callback with error guard, returns unsubscribe function.

