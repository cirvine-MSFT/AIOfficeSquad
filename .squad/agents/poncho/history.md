# Poncho — History

## Learnings
- Project started 2026-02-22. Frontend for AI Office Squad.
- AIOffice uses Phaser 3 for pixel-art rendering, Vite for dev/build.
- Web app at apps/web/, game scenes, sprites, UI panels for chat and terminal view.
- Need to adapt agent spawning UI to show squad members with roles and cast names.
- Phase 0+1 building/pod architecture implemented (Issues #11, #12, #14, #15):
  - BuildingScene (building-scene.ts): hallway with pod rooms, player walks to doors, E to enter.
  - PodScene (game.ts): renamed from OfficeScene, accepts squadId/squadName via init(), has exit zone back to building.
  - OfficeScene exported as deprecated alias for backward compat.
  - Scene transitions: BuildingScene → PodScene (via scene.start with data), PodScene → BuildingScene (Esc or walk to exit zone).
  - Multi-squad mode activated via ?building=1 URL param; single-squad mode works unchanged.
  - "Talk to Room" UI: R key toggles room chat mode, sends to /squads/{squadId}/chat endpoint (Mac builds this).
  - Room mode shows green "Room" badge in panel, distinct from agent chat.
- Pre-existing TS strict errors (10 count) in game.ts/main.ts — null-safety issues from original code, not introduced by us.
- Vite build succeeds fine despite TS strict errors (Vite uses esbuild, not tsc).
- Phase 2 frontend features implemented (Issues #3, #16, #17):
  - Decisions Panel: D key toggles slide-in panel in PodScene. Fetches from /api/squads/{squadId}/decisions. Auto-refreshes on WS decisions.update events.
  - Building Dashboard: Tab key toggles centered overlay in BuildingScene. Shows squad cards with activity status, member chips. Click to enter pod.
  - Pod Previews: Mini colored circles in BuildingScene pods. Role-based colors (Lead=gold, Frontend=blue, Backend=green, Tester=red). Pulsing animation for active members. 30s periodic refresh from API.
  - D key scoped to PodScene only (avoids WASD conflict in BuildingScene). Tab scoped to BuildingScene only.
  - All features degrade gracefully when API endpoints aren't ready yet.
- Phase 3 features implemented (Issues #6, #8):
  - Role Badges: squadBadge emoji rendered above NPC name labels in PodScene. AgentView type extended with squadBadge/squadScope fields.
  - Status Color-Coding: NPC status text has colored backgrounds (green/amber/blue/red). Thinking status pulses with tween animation.
  - Task Summary: squadScope or agent summary shown as smaller text below NPC status label.
  - Pod Status Dashboard: S key toggles overlay in PodScene. Shows all squad members with badge, name, role, status (color-coded pill), summary, and blockers. Click a member row to pan camera to their desk via focusOnAgent().
  - focusOnAgent(agentId) method on PodScene: pans camera to agent's desk, then re-follows player.
  - Dashboard fetches from /api/building/squads/{squadId}, falls back to local agents array.
- Ceremony Visualization implemented (Issue #7):
  - Conference area drawn in PodScene upper region (x:350-500, y:180-280) with dark table, border, label.
  - 6 conference seat positions around the table.
  - startCeremony(participants, type): tweens NPC sprites+labels from desks to seats (800ms Power2), shows ceremony label.
  - endCeremony(): tweens NPCs back to desks (600ms), removes label.
  - isCeremonyActive() getter for external state checks.
  - C key opens ceremony selection modal in PodScene (Design Review / Retrospective).
  - Number keys 1/2 select ceremony type, Esc cancels.
  - POST to /api/squads/{squadId}/ceremonies/{type}, falls back to local all-agents ceremony.
  - WebSocket ceremony.start/ceremony.end events trigger start/end ceremony.
  - "End Ceremony" button appears during active ceremony.
  - CSS styles for ceremony modal and end button in style.css.
- Desktop Electron app — renderer UI built (apps/desktop/src/renderer/):
  - Full 3-panel layout: Header (48px) | Sidebar(280px) + MainContent(flex) + ChatPanel(320px) | StatusBar(32px).
  - 8 React components: Header, Sidebar, BuildingView, PodView, AgentCard, ChatPanel, StreamingOutput, StatusBar.
  - All components use Tailwind classes from Hawkins' design system (design-tokens, role colors, status dots, animations).
  - App.tsx manages all state: connection, squads, roster, agent selection, chat sessions, streaming text, usage tracking.
  - Communicates via window.squadAPI (preload contextBridge) — connect, createSession, sendMessage, onStreamDelta, onStreamUsage.
  - Keyboard shortcuts: Escape to deselect, 1-9 to select agents.
  - Error banner for failed operations, loading states for connect/send.
  - Renderer types mirrored in src/renderer/types.ts (can't import from main/ due to rootDir boundary in tsconfig).
- Phase 1a — Hooks + Shared Components extraction completed:
  - `hooks/useNavigation.ts`: 3-level state machine (building→floor→office), breadcrumb generation, single-squad auto-select. Types: NavLevel, NavigationState, BreadcrumbItem, SquadLookup, SessionLookup.
  - `hooks/useChat.ts`: Extracted all chat state from App.tsx — sessions Map, messagesMap, streamingMap, usage tracking, stream delta/usage subscriptions. Identical logic to App.tsx, just relocated.
  - `components/shared/RoleAvatar.tsx`: Canonical source for getInitials(), getRoleKey(), getAvatarBg(), getRoleLabel(), getRoleTextColor(). Replaces 3 duplicated copies (AgentCard, ChatPanel, Sidebar).
  - `components/shared/StatusDot.tsx`: Tiny dot indicator with STATUS_LABELS and STATUS_BADGE_CLASSES exports. Auto-pulse for active/working.
  - `components/shared/Breadcrumb.tsx`: Clickable trail, last item non-clickable (current location). Uses BreadcrumbItem type from useNavigation.
  - Barrel index files at hooks/index.ts and components/shared/index.ts for clean imports.
  - Pattern: App.tsx chat state uses Maps keyed by agentName (sessions, messages) and sessionId (streaming). This pattern is preserved in useChat.
  - `tsconfig.renderer.json` compiles clean with strict mode — no errors in new files.
- Phase 1b — FloorView components completed:
  - `components/floor/FloorHeader.tsx`: Squad name, floor number badge, member count, active sessions badge with pulse animation.
  - `components/floor/SessionCard.tsx`: Glass-walled office room card. Status indicator (active/idle/error), mini desk previews with occupied/empty chairs, working vs idle counts, hover lift effect. Active rooms get green glow border.
  - `components/floor/NewSessionCard.tsx`: Dashed "+" card for starting new sessions. Hover highlights in accent color.
  - `components/floor/FloorView.tsx`: Grid of SessionCards + NewSessionCard, FloorHeader at top, hallway label dividers. Handles loading/empty/populated states. Dark floor background (#12151c).
  - `components/floor/types.ts`: SessionSummary and SquadDetail interfaces per Dutch's §C.5 spec.
  - `components/floor/index.ts`: Barrel re-exports for all floor components and types.
- Phase 1c — OfficeView components completed:
  - `components/office/OfficeView.tsx`: Session detail view. Two-column layout (workspace left, chat right — chat mounted by parent in Phase 1d). Header with back button, door emoji, session name/task/member count. Workspace has desk grid + water cooler side by side. Terminal panel at bottom.
  - `components/office/DeskWorkstation.tsx`: Monitor with glow effect (blue pulse when active, red for error, spinner for spawning). Nameplate with agent name + role-colored label. Chair slot with typing animation. Activity text below.
  - `components/office/WaterCooler.tsx`: Dashed-border break area with warm glow overlay. Water cooler emoji with drip animation. Idle agent cards with RoleAvatar, role label, and fun bubble text (☕ Coffee break, etc.). Empty state message.
  - `components/office/TerminalPanel.tsx`: Live streaming output with line parsing (▶ commands, ✓ success, ✗ errors). Auto-scroll, monospace font, blinking cursor when active. Max height 240px.
  - `components/office/index.ts`: Barrel re-exports for all office components and types.
- Added custom keyframe animations to globals.css: typing (desk bounce), drip (water cooler), chat (idle avatar wobble). These match the mockup animations.
- Design pattern: OfficeView does NOT render ChatPanel directly — it only renders the workspace half. ChatPanel integration happens at App.tsx level in Phase 1d, consistent with the separation of concerns.
- Pattern: Status indicator styling uses inline Tailwind for each status variant rather than CSS class maps, keeping the logic self-contained in each component.
- Phase 2 views — DecisionsTimeline + CostDashboard:
  - `components/DecisionsTimeline.tsx`: Fetches markdown from `window.squadAPI.getDecisions()`, parses `### timestamp: title` + `**By:**`/`**What:**`/`**Why:**` patterns. Vertical timeline UI with dot markers, decision cards, refresh button, empty state. Gracefully handles missing IPC (Mac adding in parallel).
  - `components/CostDashboard.tsx`: Skeleton panel showing totalTokens, estimatedCost ($X.XX), model name from useChat usage stats. Color-coded cost (green under $1, red over). Placeholder for future detailed breakdowns.
  - Preload: Added `getDecisions()` to SquadAPI interface + ipcRenderer invoke in preload/index.ts. Channel: `squad:get-decisions`.
  - App.tsx: Toolbar row added below Header with toggle buttons for Decisions/Cost panels. Panels render as 320px-wide side panels on the right edge, using `animate-fade-in`. `activePanel` state: 'none' | 'decisions' | 'cost'.
  - Pattern: Side panels are siblings of ChatPanel in the flex layout, not overlays. This keeps them composable with the existing 3-panel structure.
